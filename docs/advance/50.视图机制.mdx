---
title: 视图机制
hide_title: true
hide_table_of_contents: false
slug: app-view
---
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## 视图机制

:::note 什么是视图机制？

对于熟悉 Django RESTful 设计风格和开发方式的同学来说，可能会对 **视图机制** 有一定了解。

在 Python 中，**视图机制** 指的是通过特殊方法和语法来实现自定义对象的不同视图或视角，以提供对对象的不同表示和操作方式。

在 RESTful 风格中，我们通常以不同的 HTTP Method 来区分对资源的操作：

- GET：获取资源
- POST：新增资源
- ...

所以，在 web 开发过程中，这种对资源的完整行为的表达方式，我们称之为 **视图机制**。

:::

Pywss 通过 **`app.view`** 实现了简单的视图机制，以便更加友好的支持 RESTful 风格代码。

我们通过一个 **用户视图** 来说明。

```python title="用户视图" showLineNumbers {28}
import pywss

class UserView:

    def http_get(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "GET",
            "message": "获取用户成功",
        })

    def http_post(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "POST",
            "message": "创建用户成功",
        })

    def http_delete(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "DELETE",
            "message": "删除用户成功",
        })

def main():
    app = pywss.App()
    app.view("/api/user", UserView())  # 注意此处是一个实例
    app.run()

if __name__ == '__main__':
    main()
```

需要注意的是，在案例28行，我们通过 `app.view` 注册了一个 **用户视图实例**。

并且视图内部是**非线程安全的**，这意味在操作公共资源的时候，需要加锁。


## 文件即路由

:::caution 用前须知

**文件即路由** 是作者对路由管理的探索与实践。

关于如何更好的组织项目，作者仍然在学习中。故此模块后续 **可能会有变动**。

:::

:::note 文件即路由

**文件即路由**，是通过对 **路由文件的路径、名字** 进行管理，从而实现对路由的管理方式。

:::

为了更好的管理大型项目，Pywss 支持通过 `app.view_modules` 的方式来实现 **文件即路由** 的管理风格。

在路由文件中，有两个**内置参数**。

|内置参数|说明|
|---|---|
|**`__route__`**|用于指定当前文件路由，默认为当前文件名。|
|**`__view__`**|用于指定当前文件路由视图，默认为：`View`对象。|


我们继续通过一个案例来说明：

```text title="项目结构"
- api
  - v1
    - user.py
    - user_role.py
  - v2
    - permission.py
main.py
```

<Tabs>
  <TabItem value="main.py" label="main.py" default>

```python showLineNumbers
import pywss

def main():
    app = pywss.App()
    app.view_modules("api")  # 指定目录
    app.run()

if __name__ == '__main__':
    main()
```

  </TabItem>
  <TabItem value="user.py" label="/api/v1/user.py">

```python showLineNumbers
import pywss

__route__ = "/user"  # 默认值
__view__ = "View"  # 默认值

class View:

    def http_get(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "GET",
            "route": "/api/v1/user",
            "message": "获取用户成功",
        })

    def http_post(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "POST",
            "route": "/api/v1/user",
            "message": "创建用户成功",
        })

    def http_delete(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "DELETE",
            "route": "/api/v1/user",
            "message": "删除用户成功",
        })
```

  </TabItem>
  <TabItem value="user_role.py" label="/api/v1/user_role.py">

```python showLineNumbers
import pywss

__route__ = "/userRole"  # 指定路由，否则默认"/user_role"
__view__ = "View"  # 默认

class View:

    def http_get(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "GET",
            "route": "/api/v1/userRole",
            "message": "获取用户角色成功",
        })

    def http_post(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "POST",
            "route": "/api/v1/userRole",
            "message": "创建用户角色成功",
        })

    def http_delete(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "DELETE",
            "route": "/api/v1/userRole",
            "message": "删除用户角色成功",
        })
```

  </TabItem>
  <TabItem value="permission.py" label="/api/v2/permission.py">

```python showLineNumbers
import pywss

__route__ = "/perm"  # 指定路由，否则默认"/permission"
__view__ = "PermView"  # 指定视图，否则默认"View"

class PermView:

    def http_get(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "GET",
            "route": "/api/v2/perm",
            "message": "获取权限成功",
        })

    def http_post(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "POST",
            "route": "/api/v2/perm",
            "message": "创建用户角色成功",
        })

    def http_delete(self, ctx: pywss.Context):
        ctx.write({
            "code": 0,
            "method": "DELETE",
            "route": "/api/v2/perm",
            "message": "删除用户角色成功",
        })
```

  </TabItem>
</Tabs>

具体使用场景可参考：[pywss-be](https://github.com/czasg/pywss-react-admin-be)
